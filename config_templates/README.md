# Configuration templates

Here, we describe the HiDEF-seq pipeline's parameters, which are configured in a [YAML-format](https://en.wikipedia.org/wiki/YAML) parameters file.

We provide example template YAML files in this directory: a generic template (`analysis.template.yaml`) and an hg38-focused template (`analysis.hg38.template.yaml`) that capture commonly used settings for the hg38 reference genome.

Below, the  `parameter[].subparameter` notation indicates that `parameter` is a list that can contain multiple `subparameter` entries.

## Table of contents
- [Global analysis identifiers](#global-analysis-identifiers)
- [Sequencing runs and samples](#sequencing-runs-and-samples)
- [Individuals and germline resources](#individuals-and-germline-resources)
- [Output locations](#output-locations)
- [Container and tool paths](#container-and-tool-paths)
- [Pipeline runtime parameters](#pipeline-runtime-parameters)
- [Reference genome resources](#reference-genome-resources)
- [Call extraction settings](#call-extraction-settings)
- [Germline VCF filter definitions](#germline-vcf-filter-definitions)
- [Filter group definitions](#filter-group-definitions)
- [Region filter configuration](#region-filter-configuration)
- [Sensitivity estimation](#sensitivity-estimation)

## Global analysis identifiers

### Identifier keys
| Key | Type | Required | Description |
| --- | --- | --- | --- |
| `analysis_id` | string | yes | Unique identifier prefixed onto every output path emitted by `main.nf` and the R summary scripts. |
| `reads_type` | string (`subreads` or `ccs`) | yes | Declares the input type for `processReads`. `subreads` segments the PacBio `ccs` binary across `ccs_chunks`; `ccs` starts from pre-generated HiFi reads and skips CCS assembly. All `runs[].reads_file` entries must match this type. |

## Sequencing runs and samples

### Run-level entries
| Key | Type | Required | Notes |
| --- | --- | --- | --- |
| `runs[].run_id` | string | yes | Run identifier propagated into logs, molecule statistics, and output filenames. |
| `runs[].reads_file` | path | yes | Absolute or relative path to the CCS or subread BAM. A companion `.pbi` index is expected alongside the BAM. |
| `runs[].samples[]` | list | yes | Barcode definitions for each sample present in the run. |
| `runs[].samples[].sample_id` | string | yes | Sample identifier that must match one of the entries in the top-level `samples` block. |
| `runs[].samples[].barcode_id` | string | yes | Lima barcode label used when naming demultiplexed BAMs. |
| `runs[].samples[].barcode` | DNA sequence | yes | Forward barcode sequence written to the per-run FASTA generated by `makeBarcodesFasta`. |

### Sample metadata
| Key | Type | Required | Description |
| --- | --- | --- | --- |
| `samples[].sample_id` | string | yes | Sample identifier referenced by runs, individuals, and downstream reports. |
| `samples[].individual_id` | string | yes | Links each sample to the matching germline individual entry. |
| `samples[].tissue` | string | optional | Free-form annotation retained in run metadata tables. |

## Individuals and germline resources

### Individual-level inputs
| Key | Type | Required | Description |
| --- | --- | --- | --- |
| `individuals[].individual_id` | string | yes | Identifier joined against `samples[].individual_id`. |
| `individuals[].sex` | string (`male` or `female`) | yes | Controls sex-chromosome burden handling and sensitivity aggregation. |
| `individuals[].germline_bam_file` | path | yes | Germline-aligned BAM used to compute depth summaries and annotate variants. |
| `individuals[].germline_bam_type` | string (`Illumina` or `PacBio`) | yes | Chooses mpileup arguments within `processGermlineBAMs`. |
| `individuals[].germline_vcf_files[]` | list | optional | Collection of VCF/BCF files describing germline variants. |
| `individuals[].germline_vcf_files[].germline_vcf_file` | path | yes (if list present) | Bgzipped VCF/BCF processed by `processGermlineVCFs`. Must have a matching index. |
| `individuals[].germline_vcf_files[].germline_vcf_type` | string | yes (if list present) | Identifier that maps to a `germline_vcf_types` entry to attach filtering thresholds. |

## Output locations

### Paths
| Key | Type | Required | Description |
| --- | --- | --- | --- |
| `analysis_output_dir` | path | yes | Root directory for per-sample output folders (`processReads`, `outputResults`, etc.). |
| `cache_dir` | path | yes | Shared cache for reference-dependent intermediates (BSgenome archives, region filters, processed germline resources). The path must be writable by Nextflow executors and bind-mounted when using Singularity. |

## Container and tool paths

### Container and environment hooks
| Key | Type | Required | Description |
| --- | --- | --- | --- |
| `hidefseq_container` | string | yes | Docker image reference (`docker://…`) or Singularity `.sif` path loaded for all processes. |
| `conda_base_script` | path | defaults to `/hidef/miniconda3/etc/profile.d/conda.sh` | Script sourced prior to activating bundled conda environments. |
| `conda_pbbioconda_env` | path | defaults to `/hidef/bin/pbconda` | Conda environment housing PacBio command-line tools. |
| `samtools_bin`, `bcftools_bin`, `bedGraphToBigWig_bin`, `wiggletools_bin`, `wigToBigWig_bin`, `seqkit_bin`, `bedtools_bin`, `bgzip_bin`, `tabix_bin` | string | yes | Command names or absolute paths invoked inside the container. Override when supplying custom installations. |
| `ccs_ld_preload` | path | optional | Shared library path exported via `LD_PRELOAD` before invoking the PacBio `ccs` binary, mitigating thread-affinity issues described in <a href="https://github.com/microsoft/onnxruntime/issues/10736" target="_blank" rel="noopener noreferrer">onnxruntime issue #10736</a>. Leave blank to disable. |

## Pipeline runtime parameters

### Nextflow chunking and retries
| Key | Type | Required | Description |
| --- | --- | --- | --- |
| `ccs_chunks` | integer | required when `reads_type: subreads` | Number of segments passed to the PacBio `ccs` binary (`ccsChunk` process). Each chunk emits partial HiFi reads that are merged downstream. |
| `lima_min_score` | integer | optional | Minimum Lima barcode score enforced by `limaDemux`. |
| `analysis_chunks` | integer | yes | Number of BAM chunks emitted per sample for the `splitBAMs` ➝ `filterCalls` stages. Higher values increase parallelism. |
| `mem_extractCallsChunk`, `time_extractCallsChunk`, `maxRetries_extractCallsChunk` | string/integer | optional | Baseline memory, wall-clock limit, and retry count for `extractCallsChunk`. Retries progressively increase requested resources as coded in `main.nf`. |
| `mem_filterCallsChunk`, `time_filterCallsChunk`, `maxRetries_filterCallsChunk` | string/integer | optional | Analogous overrides for `filterCallsChunk`. |
| `mem_calculateBurdensChromgroupFiltergroup`, `time_calculateBurdensChromgroupFiltergroup`, `maxRetries_calculateBurdensChromgroupFiltergroup` | string/integer | optional | Resource configuration for the burden summarisation steps. |
| `remove_intermediate_files` | boolean | optional | When true, enables the `removeIntermediateFiles` workflow segment to delete intermediate per-sample directories once outputs are finalised. |

## Reference genome resources

### Required files
| Key | Type | Required | Description |
| --- | --- | --- | --- |
| `genome_fasta` | path | yes | Reference FASTA used by pbmm2 alignment and R-based summaries. |
| `genome_fai` | path | yes | FASTA index produced by `samtools faidx`. |
| `genome_mmi` | path | yes | pbmm2 minimap2 index produced by `pbmm2 index`. |
| `BSgenome.BSgenome_name` | string | yes | BSgenome package name (for example `BSgenome.Hsapiens.UCSC.hg38`) loaded by the R scripts. |
| `BSgenome.BSgenome_file` | path | optional | Tarball containing a custom BSgenome build. When supplied, `installBSgenome.R` installs it into `cache_dir`. |
| `sex_chromosomes` | comma-separated string | yes | Chromosome identifiers treated as sex chromosomes and excluded from sensitivity borrowing. |
| `mitochondrial_chromosome` | string | yes | Identifier for mitochondrial DNA. |

### Chromosome grouping
| Key | Type | Required | Description |
| --- | --- | --- | --- |
| `chromgroups[]` | list | yes | Declares groups of chromosomes processed together. |
| `chromgroups[].chromgroup` | string | yes | Group name used when naming output subdirectories and burden summaries. |
| `chromgroups[].chroms` | comma-separated string | yes | Chromosome identifiers included in the group. |

## Call extraction settings

### Overlap and call type structure
| Key | Type | Required | Description |
| --- | --- | --- | --- |
| `min_strand_overlap` | float (0–1) | yes | Minimum fraction of forward/reverse read overlap required prior to extracting calls. |
| `call_types[]` | list | yes | Defines each call class processed downstream. |
| `call_types[].call_type` | string | yes | Logical label for the call class (for example `SBS`, `insertion`, or custom MDB tags). |
| `call_types[].call_class` | string (`SBS`, `indel`, `MDB`) | yes | Directs R scripts toward the correct processing branch. |
| `call_types[].analyzein_chromgroups` | string | yes | Either `all` or a comma-separated subset of `chromgroups[].chromgroup` values indicating where the call type is analysed. |
| `call_types[].SBSindel_call_types[]` | list | yes | Call subtypes evaluated for the parent call type. |
| `call_types[].SBSindel_call_types[].SBSindel_call_type` | string | yes | Subclass label (for example `mutation`, `mismatch-ss`, `mismatch-ds`, `mismatch-os`, `match`). |
| `call_types[].SBSindel_call_types[].filtergroup` | string | yes | References a `filtergroups[].filtergroup` that governs molecule-level filters for the subtype. |

### MDB-specific options
| Key | Type | Required | Description |
| --- | --- | --- | --- |
| `call_types[].MDB_bamtag` | string | required for MDB entries | BAM auxiliary tag storing MDB scores. |
| `call_types[].MDB_min_score` | numeric | required for MDB entries | Minimum strand score enforced during extraction. |
| `call_types[].MDB_sensitivity` | float | optional | Sensitivity applied when correcting burdens for MDB call types. |
| `call_types[].MDB_base_opposite_strand` | string or `null` | optional | When set, requires the specified base on the opposite strand for MDB evaluation; `null` disables the constraint. |

## Germline VCF filter definitions

### Threshold fields
| Key | Type | Description |
| --- | --- | --- |
| `germline_vcf_type` | string | Identifier referenced by individuals. |
| `SBS_FILTERS[]` | list of strings | Filters whose presence in the VCF `FILTER` column removes the SBS variant. Quote `.` when retaining PASS sites. |
| `SBS_min_Depth`, `SBS_min_VAF`, `SBS_min_GQ`, `SBS_min_QUAL` | numeric | Minimum depth, allele fraction, genotype quality, and QUAL required for SBS calls. |
| `indel_FILTERS[]` | list of strings | Filters to exclude for indels. |
| `indel_min_Depth`, `indel_min_VAF`, `indel_min_GQ`, `indel_min_QUAL` | numeric | Minimum thresholds for indel records. |
| `indel_inspad`, `indel_delpad` | string or `NA` | Padding strings encoded as `m<multiplier>b<offset>` (for example `m2b15`). `m` multiplies the insertion or deletion length, `b` adds a fixed base count, and the pipeline expands both sides of the site by the larger of those two numbers. Use `NA` to disable padding for the respective event type. Values feed into germline VCF region filters. |

## Filter group definitions

### Molecule-level filters
| Key | Description |
| --- | --- |
| `filtergroup` | Name referenced by `call_types[].SBSindel_call_types[].filtergroup`. |
| `min_rq_eachstrand`, `min_rq_avgstrands` | Minimum read-quality (`rq`) thresholds applied per strand and to the average across both strands. The `avgstrands` checks compute the mean of the two strand values before comparison. |
| `min_ec_eachstrand`, `min_ec_avgstrands` | Minimum polymerase pass counts (`ec`) per strand and averaged across strands. |
| `min_mapq_eachstrand`, `min_mapq_avgstrands` | Minimum mapping quality thresholds per strand and averaged across strands. |
| `max_num_SBScalls_eachstrand`, `max_num_SBScalls_stranddiff` | Maximum SBS call counts per strand and allowable imbalance between strands. |
| `max_num_SBSmutations` | Maximum SBS mutations per molecule prior to filtering. |
| `max_num_indelcalls_eachstrand`, `max_num_indelcalls_stranddiff`, `max_num_indelmutations` | Analogous indel controls for call counts and mutations. |
| `max_num_softclipbases_eachstrand`, `max_num_softclipbases_avgstrands` | Soft-clip thresholds per strand and averaged across strands. |
| `max_num_SBScalls_postVCF_eachstrand`, `max_num_SBSmutations_postVCF` | Post-germline SBS limits enforced after VCF filtering. |
| `max_num_indelcalls_postVCF_eachstrand`, `max_num_indelmutations_postVCF` | Post-germline indel limits. |
| `min_qual`, `min_qual_method` | Minimum HiFi `qual` score threshold and aggregation method. `min_qual_method` accepts `mean`, `all`, or `any`, matching the helper function in `filterCalls.R` that respectively tests mean scores, requires all positions above threshold, or allows any position above threshold for multi-base events. |
| `read_trim_bp` | Number of bases trimmed from each read end before evaluating filters. |
| `ccsindel_inspad`, `ccsindel_delpad` | Padding strings using the same `m<multiplier>b<offset>` syntax described above, applied when intersecting indels with CCS subreads to derive coverage statistics. Set the value to `NA` to disable padding entirely; otherwise specify the multiplier/offset pair (for example `m1b10`). |
| `min_BAMTotalReads`, `max_BAMVariantReads`, `max_BAMVAF` | Depth-based thresholds computed from germline BAM pileups. |
| `min_frac_subreads_cvg`, `min_num_subreads_match`, `min_frac_subreads_match` | Subread coverage thresholds derived from `sa`, `sm`, and `sx` tags. |
| `min_subreads_cvgmatch_method` | Aggregation method (`mean`, `all`, or `any`) applied when summarising subread coverage metrics across multi-base events. |
| `max_finalcalls_eachstrand` | Maximum allowed final calls per strand; molecules exceeding the cap are discarded. |

`avgstrands` suffixes indicate that the pipeline calculates the metric independently for the plus and minus strand of each molecule and then compares the arithmetic mean `(plus + minus) / 2` against the configured threshold. Padding string options for CCS coverage reuse the `m<multiplier>b<offset>` convention explained in the germline VCF filter table above.

## Region filter configuration

### Read filters (`region_filters[].read_filters[]`)
| Key | Description |
| --- | --- |
| `region_filter_file` | bigWig track providing per-base scores. |
| `binsize` | Integer bin size used when rescaling the bigWig to genomic intervals. |
| `threshold` | Comparison encoded as `<operator><value>` using `lt` (<), `lte` (≤), `gt` (>), or `gte` (≥); for example `gte0.1`. |
| `padding` | Number of bases expanded around filtered intervals. |
| `read_threshold` | Optional per-read comparison using the same operator syntax as `threshold`. |
| `applyto_chromgroups` | `all` or a comma-separated list of chromgroups receiving the filter. |
| `applyto_filtergroups` | `all` or a comma-separated list of filter groups inheriting the filter. |
| `is_germline_filter` | Boolean indicating whether the filter targets germline contexts. Germline filters are excluded from sensitivity calculations. |

### Genome filters (`region_filters[].genome_filters[]`)
| Key | Description |
| --- | --- |
| `region_filter_file` | bigWig describing genome regions to mask during burden calculations. |
| `binsize`, `threshold`, `padding` | Same semantics as the read filters. |
| `applyto_chromgroups`, `applyto_filtergroups`, `is_germline_filter` | Behave as in the read filter configuration (without a `read_threshold`). |

## Sensitivity estimation

### Sensitivity parameters
| Key | Type | Description |
| --- | --- | --- |
| `sensitivity_parameters.use_chromgroup` | string | Chromgroup whose sensitivity estimates seed other groups. Leave blank to skip sensitivity correction (burdens default to 1.0). |
| `sensitivity_parameters.sensitivity_vcf` | path | External population reference germline VCF used to identify high-confidence heterozygous or homozygous variants for sensitivity analysis. |
| `sensitivity_parameters.genotype` | string (`heterozygous` or `homozygous`) | Determines which genotype states are tallied when measuring detection sensitivity. |
| `sensitivity_parameters.SBS_min_Depth_quantile`, `SBS_min_VAF`, `SBS_max_VAF`, `SBS_min_GQ_quantile`, `SBS_min_QUAL_quantile`, `SBS_min_variant_detections` | numeric | Thresholds applied to SBS variants; quantile parameters evaluate empirical distributions, whereas absolute thresholds apply directly. |
| `sensitivity_parameters.indel_min_Depth_quantile`, `indel_min_VAF`, `indel_max_VAF`, `indel_min_GQ_quantile`, `indel_min_QUAL_quantile`, `indel_min_variant_detections` | numeric | Analogous thresholds for indel sensitivity selection. |
| `sensitivity_parameters.default_sensitivity` | numeric | Optional fallback sensitivity applied when no qualifying variants are detected. |

MDB-specific sensitivity overrides can also be provided per call type through `call_types[].MDB_sensitivity`.
