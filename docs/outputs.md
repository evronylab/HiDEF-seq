# HiDEF-seq pipeline outputs

This guide documents every final output generated by the `processReads` and `outputResults` workflows in `main.nf`, including file structure, serialized objects, and column-level metadata for each table.

## Directory layout
For each sample (`sample_id`) belonging to an individual (`individual_id`), HiDEF-seq creates a base directory:

```
${analysis_output_dir}/${analysis_id}.${individual_id}.${sample_id}/
```

Under this directory the pipeline writes workflow-specific subfolders (`processReads`, `splitBAMs`, …) and a shared `logs` directory containing process command logs. Only artifacts produced by `processReads` and `outputResults` are covered here.

## processReads outputs
Location: `${analysis_output_dir}/${analysis_id}.${individual_id}.${sample_id}/processReads/`

| File | Description |
| --- | --- |
| `${analysis_id}.${individual_id}.${sample_id}.ccs.filtered.aligned.sorted.bam` | HiFi CCS reads that passed adapter trimming, demultiplexing, and pbmm2 alignment. Records are sorted by coordinate. |
| `${analysis_id}.${individual_id}.${sample_id}.ccs.filtered.aligned.sorted.bam.bai` | BAM index generated by `samtools index`. |
| `${analysis_id}.${individual_id}.${sample_id}.ccs.filtered.aligned.sorted.bam.pbi` | PacBio BAM index produced by `pbindex`. |

Additional read-level quality control files are published to the shared logs directory:

- `*.zmwcount.txt` — ZMW counts recorded after each major processing stage (`countZMWs`).
- `${task.process}.command.log` — execution logs for every Nextflow process touching the sample.

## outputResults outputs
Location: `${analysis_output_dir}/${analysis_id}.${individual_id}.${sample_id}/outputResults/`

Top-level files:

| File | Description |
| --- | --- |
| `${analysis_id}.${individual_id}.${sample_id}.yaml_config.tsv` | Exact copy of the YAML parameter file supplied to the run (captured for provenance). |
| `${analysis_id}.${individual_id}.${sample_id}.run_metadata.tsv` | Join of BAM read-group metadata with sample annotations (`analysis_id`, `individual_id`, `sample_id`). Columns mirror the RG header fields present in the CCS BAMs (e.g., `rg_id`, `movie_id`, `SM`, `PM`, `PL`, `DS`, `PU`) and therefore may vary depending on input metadata. |
| `${analysis_id}.${individual_id}.${sample_id}.qs2` | Serialized `qs2` object containing every R data object listed in [Serialized objects](#serialized-objects). |

### Serialized objects
The `.qs2` file stores a named list with the following elements:

- `yaml.config` — Parsed configuration parameters used by the R scripts.
- `run_metadata` — Read-group metadata table (same columns as `.run_metadata.tsv`).
- `individual_id` — Character scalar.
- `sample_id` — Character scalar.
- `chromgroup` — Name of the chromgroup processed in the `calculateBurdens` chunk.
- `filtergroup` — Filter group identifier for the chunk.
- `call_types` — Tibble describing call-type configuration (subset of the YAML `call_types` entry).
- `molecule_stats.by_run_id` — Per-run filtering statistics.
- `molecule_stats.by_analysis_id` — Aggregated filtering statistics across runs.
- `region_genome_filter_stats` — Genome mask accounting table.
- `bam.gr.filtertrack.bytype.coverage_tnc` — Coverage summaries for each chromgroup/filtergroup/call-type combination, including per-trinucleotide counts.
- `finalCalls` — Strand-resolved calls that passed all filters (one row per strand per call).
- `finalCalls.bytype` — Nested representation of final calls grouped by call class/type/SBSindel subtype (used to build TSV/VCF outputs).
- `germlineVariantCalls` — Germline variant detections per strand for filtered molecules.
- `finalCalls.reftnc_spectra` — Trinucleotide spectra derived from final calls.
- `finalCalls.burdens` — Burden calculations per chromgroup/filtergroup/call subtype, before sensitivity correction.
- `genome.reftnc` — Reference-genome trinucleotide counts and fractions.
- `genome_chromgroup.reftnc` — Per-chromgroup trinucleotide statistics.
- `sensitivity` — Sensitivity estimates per call subtype (may contain `NA` when not computed).
- `estimatedSBSMutationErrorProbability` — Trinucleotide-specific SBS error probability summaries.

### `filterStats/`
Each chromgroup/filtergroup combination yields three TSVs named:

```
${chromgroup}.filterStats/${analysis_id}.${individual_id}.${sample_id}.${chromgroup}.${filtergroup}.{table}.tsv
```

Tables and columns:

1. `molecule_stats.by_run_id.tsv` — columns: `analysis_id`, `individual_id`, `sample_id`, `chromgroup`, `filtergroup`, `run_id`, `stat`, `value`. The `stat` field encodes the sequential filters applied (for example `num_molecules.min_rq_eachstrand.passfilter`, `num_refspacebases_remaining.nonindelanalysis.passgenomeregionfilters`).
2. `molecule_stats.by_analysis_id.tsv` — same as above without the `run_id` column (statistics aggregated across runs).
3. `region_genome_filter_stats.tsv` — columns: `analysis_id`, `individual_id`, `sample_id`, `chromgroup`, `filtergroup`, `filter`, `binsize`, `threshold`, `padding`, `region_filter_threshold_file`, `num_genomebases_individually_filtered`, `num_genomebases_remaining`.

### `finalCalls/`
File pattern:

```
${chromgroup}.finalCalls/${analysis_id}.${individual_id}.${sample_id}.${chromgroup}.${filtergroup}.${call_class}.${call_type}.${SBSindel_call_type}.finalCalls.tsv
${chromgroup}.finalCalls/${analysis_id}.${individual_id}.${sample_id}.${chromgroup}.${filtergroup}.${call_class}.${call_type}.${SBSindel_call_type}.finalCalls_unique.tsv
${chromgroup}.finalCalls/${analysis_id}.${individual_id}.${sample_id}.${chromgroup}.${filtergroup}.${call_class}.${call_type}.${SBSindel_call_type}.finalCalls.vcf
${chromgroup}.finalCalls/${analysis_id}.${individual_id}.${sample_id}.${chromgroup}.${filtergroup}.${call_class}.${call_type}.${SBSindel_call_type}.finalCalls_unique.vcf
```

#### `.finalCalls.tsv`
Columns fall into three groups:

- **Metadata**: `analysis_id`, `individual_id`, `sample_id`, `chromgroup`, `filtergroup`, `call_class`, `call_type`, `SBSindel_call_type`, `analysis_chunk` (chunk number), `run_id`, `zm` (ZMW identifier).
- **Call coordinates and context**: `seqnames`, `start_refspace`, `end_refspace`, `ref_plus_strand`, `alt_plus_strand`, `reftnc_plus_strand`, `alttnc_plus_strand`, `reftnc_pyr`, `alttnc_pyr`, `indel_width` (indel length; 0 for SBS), `MDB_score_refstrand_plus_read`/`MDB_score_refstrand_minus_read` (MDB-only, absent for SBS/indel).
- **Per-strand attributes**: every strand-resolved measurement appears twice with suffixes `_refstrand_plus_read` and `_refstrand_minus_read`. Base column names include `start_queryspace`, `end_queryspace`, `qual`, `qual.opposite_strand`, `sa`, `sa.opposite_strand`, `sm`, `sm.opposite_strand`, `sx`, `sx.opposite_strand`, `call_class.opposite_strand`, `call_type.opposite_strand`, `alt_plus_strand.opposite_strand`, `deletion.bothstrands.startendmatch`. Optional names (`MDB_score`, `sa/sm/sx` lists) are blank when not applicable to a call class. Values are lists expanded to comma-separated strings for multi-base events.

#### `.finalCalls_unique.tsv`
Contains one row per unique mutation (SBS or indel `SBSindel_call_type == mutation`). Columns: the metadata and context columns listed above **without** the strand-specific suffixes (`analysis_id` through `indel_width`).

#### VCF outputs
The `.vcf` files contain the same call sets as the TSVs after indel normalization. INFO fields include every column from the corresponding TSV except `seqnames`, `start_refspace`, `ref_plus_strand`, and `alt_plus_strand` (which populate CHROM, POS, REF, ALT). Strand-specific attributes are recorded as semicolon-delimited strings with keys mirroring the TSV column names (`qual_refstrand_plus_read`, etc.). All records carry `FILTER=PASS`.

### `germlineVariantCalls/`
Per chromgroup/filtergroup TSV and VCF pairs summarise germline variants detected in HiDEF-seq molecules.

- File naming mirrors the `finalCalls` convention with the suffix `.germlineVariantCalls.{tsv,vcf}`.
- Metadata columns: `analysis_id`, `individual_id`, `sample_id`, `chromgroup`, `filtergroup`, `analysis_chunk`, `run_id`, `zm`, `call_class` (always `SBS`), `call_type`, `seqnames`, `start_refspace`, `end_refspace`, `ref_plus_strand`, `alt_plus_strand`, `reftnc_plus_strand`, `alttnc_plus_strand`, `reftnc_pyr`, `alttnc_pyr`, `indel_width`.
- Germline filter flags (identical across strands and therefore unsuffixed): `germline_vcf.passfilter`, any `germline_vcf_indel_region_filter_*`, `max_BAMVariantReads.passfilter`, `max_BAMVAF.passfilter`, and all germline-specific read/genome filter columns (`region_read_filter_*.passfilter`, `region_genome_filter_*.passfilter`) defined as `is_germline_filter: true` in the YAML.
- Per-strand columns with `_refstrand_plus_read`/`_refstrand_minus_read` suffixes: `start_queryspace`, `end_queryspace`, `qual`, `qual.opposite_strand`, `sa`, `sa.opposite_strand`, `sm`, `sm.opposite_strand`, `sx`, `sx.opposite_strand`, `call_class.opposite_strand`, `call_type.opposite_strand`, `alt_plus_strand.opposite_strand`, `deletion.bothstrands.startendmatch`.
- VCF INFO annotations follow the same mapping as in `finalCalls`.

### `finalCalls.spectra/`
For every chromgroup/filtergroup/call subtype, the pipeline writes spectrum tables and plots named:

- `.finalCalls.reftnc_pyr.tsv` — columns: metadata (`analysis_id`, `individual_id`, `sample_id`, `chromgroup`, `filtergroup`, `call_class`, `call_type`, `SBSindel_call_type`) plus `reftnc_pyr`, `count`, `fraction`.
- `.finalCalls_unique.reftnc_pyr.tsv` — same structure for unique SBS mutations (present only when subtype is `mutation`).
- `.finalCalls.reftnc_template_strand.tsv` — metadata plus `reftnc_template_strand`, `count`, `fraction` (SBS mismatch and MDB contexts).
- `.finalCalls.reftnc_pyr_spectrum.tsv` and `.finalCalls_unique.reftnc_pyr_spectrum.tsv` — metadata plus `channel` (96-channel label), `count`, `fraction`.
- `.finalCalls.reftnc_template_strand_spectrum.tsv` — metadata plus `channel`, `count`, `fraction` for template-strand spectra.
- `.finalCalls.refindel_spectrum.sigfit.tsv` and `.finalCalls_unique.refindel_spectrum.sigfit.tsv` — metadata plus `channel` (96 indel context labels) and `count`, `fraction`.

Each TSV has companion spectrum plots (`.pdf`) sharing the same naming prefix with suffix `.sigfit.pdf` for the plotted distributions.

### `interrogatedBases.spectra/`
These tables report trinucleotide composition of interrogated bases (i.e., duplex coverage).

- `.bam.gr.filtertrack.reftnc_pyr.tsv` — metadata columns (`analysis_id`, `individual_id`, `sample_id`, `chromgroup`, `filtergroup`, `call_class`, `call_type`, `SBSindel_call_type`) plus `reftnc_pyr`, `count`, `fraction`.
- `.bam.gr.filtertrack.reftnc_both_strands.tsv` — metadata plus `reftnc` (plus-strand context), `count`, `fraction`.

### `genome.spectra/`
For each chromgroup a subdirectory contains four tables derived from `genome.reftnc` and `genome_chromgroup.reftnc`:

- `genome.reftnc_pyr.tsv` — columns: `analysis_id`, `individual_id`, `sample_id`, `reftnc_pyr`, `count`, `fraction`.
- `${chromgroup}.genome_chromgroup.reftnc_pyr.tsv` — same columns restricted to the chromgroup.
- `genome.reftnc_both_strands.tsv` — `analysis_id`, `individual_id`, `sample_id`, `reftnc`, `count`, `fraction`.
- `${chromgroup}.genome_chromgroup.reftnc_both_strands.tsv` — chromgroup-specific `reftnc`, `count`, `fraction`.

### `sensitivity/`
Per call subtype TSV files (`.sensitivity.tsv`) contain:

- Columns: `analysis_id`, `individual_id`, `sample_id`, `chromgroup`, `filtergroup`, `call_class`, `call_type`, `SBSindel_call_type`, `sensitivity`, `sensitivity_source`, `high_confidence_germline_vcf_variants_sum_zm_detected` (total HiDEF-seq detections of the high-confidence germline variants), `high_confidence_germline_vcf_variants_sum_duplex_coverage` (aggregate duplex coverage across those variants), and a nested column `high_confidence_germline_vcf_variants` summarising the contributing variant records (empty when sensitivity was not computed). Rows marked `sensitivity_source` = `default_other_chromgroup` use a fallback sensitivity of 1.

### `finalCalls.burdens/`
Each `.finalCalls.burdens.tsv` reports burden summaries before and after sensitivity correction. Columns:

- Metadata: `analysis_id`, `individual_id`, `sample_id`, `chromgroup`, `filtergroup`, `call_class`, `call_type`, `SBSindel_call_type`.
- Count metrics: `num_calls`, `interrogated_bases_or_bp` (effective genome size), `sensitivity`, `sensitivity_source`, `sensitivity_corrected` (boolean).
- Burden metrics: `burden_calls`, `burden_calls_lci`, `burden_calls_uci` (Poisson 95% CI), `num_calls_lci`, `num_calls_uci`.

### `estimatedSBSMutationErrorProbability/`
`.estimatedSBSMutationErrorProbability.tsv` files store two structures per call subtype:

- Metadata columns: `analysis_id`, `individual_id`, `sample_id`, `chromgroup`, `filtergroup`, `call_class`, `call_type`, `SBSindel_call_type`.
- A nested tibble `by_channel_pyr` expanded by `write_tsv` into rows with `channel_pyr` (96-channel SBS label) and `error_prob` (per-channel SBS mismatch error probability). A scalar column `total` records the summed SBS mutation error probability across all channels.

